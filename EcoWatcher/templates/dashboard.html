<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>EcoSense - Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <style>
    /* Loader overlay */
    #loader {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(255,255,255,0.85);
      display:flex; justify-content:center; align-items:center;
      z-index:10000; opacity:1; pointer-events: all;
      transition: opacity 0.3s ease;
    }
    #loader.hidden { opacity:0; pointer-events: none; }

    #loader::after {
      content:''; width:50px; height:50px;
      border:5px solid #3498db; border-top:5px solid transparent; border-radius:50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    /* Ocultar contenido inicialmente */
    #dashboard-content { opacity:0; transition: opacity 0.5s ease; }
    #dashboard-content.visible { opacity:1; }
  </style>
</head>
<body>

<div id="dashboard">

  <!-- Loader -->
  <div id="loader"></div>

  <div id="dashboard-content">
    <h1>Dashboard EcoSense</h1>

    <a href="/" class="dashboard-btn">← Volver al formulario</a>
    <button id="btn-tabla" class="dashboard-btn">Mostrar Rangos EcoScore</button>

    <div class="tab-content active" id="main-panel">
      <div class="card" id="card-principal">
        <h2>Último EcoScore</h2>
        <p id="ultimo" class="eco-score">Cargando...</p>
        <span id="estado" class="eco-state">---</span>
        <p id="tendencia"></p>
        <div id="alerta">Estado CRÍTICO: El ecosistema está en mala condición.</div>
      </div>

      <div class="card" id="card-grafico">
        <h2>Tendencia del EcoScore (últimos 30 registros)</h2>
        <canvas id="grafico"></canvas>
      </div>
    </div>

    <dialog id="modal-tabla">
      <div class="dialog-inner">
        <h2>Rangos EcoScore</h2>
        <table>
          <thead>
            <tr><th>Puntaje</th><th>Categoría</th></tr>
          </thead>
          <tbody>
            <tr><td>0 - 199</td><td><span class="table-label critico">Crítico</span></td></tr>
            <tr><td>200 - 349</td><td><span class="table-label moderado">Moderado</span></td></tr>
            <tr><td>350 - 449</td><td><span class="table-label bueno">Bueno</span></td></tr>
            <tr><td>+450</td><td><span class="table-label excelente">Excelente</span></td></tr>
          </tbody>
        </table>
        <button id="cerrar-tabla">Cerrar</button>
      </div>
    </dialog>

  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- JS del dashboard -->
<script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const loader = document.getElementById('loader');
  const content = document.getElementById('dashboard-content');

  // Mostrar loader 1s antes de mostrar el contenido
  setTimeout(async () => {
    loader.classList.add('hidden');
    content.classList.add('visible');

    // Después de mostrar, cargar último ecoscore y dibujar gráfico
    if(window._eco) {
      await window._eco.cargarUltimo();
      await window._eco.dibujarGrafico();
    }
  }, 1000);

  // Modal tabla
  const btnAbrir = document.getElementById('btn-tabla');
  const btnCerrar = document.getElementById('cerrar-tabla');
  const modal = document.getElementById('modal-tabla');
  btnAbrir.addEventListener('click', () => modal.showModal());
  btnCerrar.addEventListener('click', () => modal.close());

  // Loader al ir a otra página
  document.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      loader.classList.remove('hidden');
      content.classList.remove('visible');
      setTimeout(() => { window.location.href = link.href; }, 1000);
    });
  });

});
</script>

</body>
</html>